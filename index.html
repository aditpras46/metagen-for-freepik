<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metagen AI: ZERO_LATENCY_GITHUB</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load JetBrains Mono Font for Terminal look -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#020202',
                            dark: '#051a05',
                            dim: '#0a2e0a',
                            primary: '#00ff41', // Matrix Green
                            bright: '#ccffcc',
                            alert: '#ff003c',
                            warning: '#ffff00',
                            accent: '#008F11'
                        }
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #000000;
            background-image: 
                linear-gradient(rgba(0, 255, 65, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            color: #00ff41;
            overflow-x: hidden;
        }

        /* Minimal scrollbar for speed */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #0a4f0a; }
        ::-webkit-scrollbar-thumb:hover { background: #00ff41; }

        .cyber-panel {
            background: rgba(2, 8, 2, 0.95);
            border: 1px solid #0a4f0a;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.05);
        }

        .cyber-input {
            background: #000000;
            border: 1px solid #0a4f0a;
            color: #00ff41;
            font-family: 'JetBrains Mono', monospace;
        }
        .cyber-input:focus {
            border-color: #00ff41;
            outline: none;
        }

        .btn-cyber {
            background: #000;
            border: 1px solid #00ff41;
            color: #00ff41;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .btn-cyber:hover:not(:disabled) {
            background: #00ff41;
            color: #000;
        }
        .btn-cyber:disabled {
            border-color: #0a2e0a;
            color: #0a2e0a;
            cursor: not-allowed;
        }

        /* Active Row Highlight */
        .active-row {
            background: rgba(0, 255, 65, 0.1);
            border-left: 2px solid #00ff41;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

    <!-- Top Bar -->
    <header class="h-14 border-b border-cyber-dim flex items-center justify-between px-6 bg-black shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-cyber-primary rounded-full animate-pulse"></div>
            <h1 class="font-bold tracking-widest text-lg">METAGEN_AI <span class="text-xs text-cyber-primary/50 ml-2">v4.4_DEFAULT_KEY</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="systemStatus" class="text-xs text-cyber-primary/70 font-mono hidden sm:block">SYSTEM_IDLE</div>
            
            <!-- API Key Button -->
            <button onclick="toggleKeyModal()" class="text-cyber-primary/50 hover:text-cyber-primary transition-colors" title="Configure API Key">
                <i data-lucide="key" class="w-4 h-4"></i>
            </button>

            <div class="h-4 w-px bg-cyber-dim mx-2"></div>

            <button onclick="document.getElementById('imageUpload').click()" class="btn-cyber px-4 py-1.5 text-xs flex items-center gap-2">
                <i data-lucide="upload" class="w-3 h-3"></i> LOAD FILES
            </button>
            <input type="file" id="imageUpload" multiple accept="image/*" class="hidden" onchange="handleFileSelect(this.files)">
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar: File List (Text Only for Performance) -->
        <div class="w-2/3 flex flex-col border-r border-cyber-dim bg-black/50">
            <!-- Toolbar -->
            <div class="p-3 border-b border-cyber-dim flex justify-between items-center bg-black">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-cyber-primary/60">QUEUE:</span>
                    <span id="queueCount" class="font-bold">0</span>
                </div>
                <div class="flex gap-2">
                    <button id="generateButton" onclick="startProcessing()" disabled class="btn-cyber px-3 py-1 text-xs">
                        START PROCESS
                    </button>
                    <button id="exportButton" onclick="exportCSV()" disabled class="btn-cyber px-3 py-1 text-xs border-cyber-accent text-cyber-accent hover:bg-cyber-accent">
                        EXPORT CSV
                    </button>
                </div>
            </div>

            <!-- Virtualized-like List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar relative bg-black" id="fileListContainer">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-cyber-dark z-10 text-xs uppercase tracking-wider text-cyber-primary/70">
                        <tr>
                            <th class="p-2 border-b border-cyber-dim w-12">#</th>
                            <th class="p-2 border-b border-cyber-dim">Filename</th>
                            <th class="p-2 border-b border-cyber-dim w-24">Status</th>
                            <th class="p-2 border-b border-cyber-dim w-1/4">Title (Preview)</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody" class="text-xs text-cyber-primary/80 divide-y divide-cyber-dim/30">
                        <!-- Rows injected here -->
                        <tr>
                            <td colspan="4" class="p-8 text-center text-cyber-dim italic">
                                NO_DATA // WAITING FOR INPUT
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Panel: Active Job & Details -->
        <div class="w-1/3 flex flex-col bg-cyber-dark/30 relative">
            
            <!-- Active Image Preview (Only shows ONE image at a time) -->
            <div class="h-1/3 border-b border-cyber-dim p-4 flex flex-col relative bg-black">
                <div class="absolute top-2 left-2 text-[10px] text-cyber-primary/40 uppercase tracking-widest border border-cyber-dim px-2 py-0.5">Active Processor</div>
                
                <div id="activeImageContainer" class="flex-1 flex items-center justify-center border border-cyber-dim/50 border-dashed bg-cyber-dim/5 m-4">
                    <div class="text-center text-cyber-primary/30">
                        <i data-lucide="aperture" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="text-[10px]">VISUAL FEED STANDBY</p>
                    </div>
                </div>
                <img id="activeImage" class="absolute inset-0 w-full h-full object-contain p-4 hidden z-10" alt="Active Processing">
                
                <!-- Progress Bar -->
                <div class="h-1 w-full bg-cyber-dim mt-auto absolute bottom-0 left-0">
                    <div id="progressBar" class="h-full bg-cyber-primary transition-all duration-300 w-0 shadow-[0_0_10px_#00ff41]"></div>
                </div>
            </div>

            <!-- Detail Editor for Selected/Active Item -->
            <div class="flex-1 flex flex-col p-4 overflow-y-auto bg-black border-l border-cyber-dim">
                <h3 class="text-xs font-bold text-cyber-primary mb-3 uppercase flex items-center gap-2">
                    <i data-lucide="edit-3" class="w-3 h-3"></i> Metadata Editor
                </h3>
                
                <div class="space-y-4 flex-1">
                    <div>
                        <label class="text-[10px] uppercase text-cyber-primary/60 mb-1 block">Title</label>
                        <textarea id="editTitle" rows="2" class="cyber-input w-full p-2 text-xs" placeholder="..."></textarea>
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-cyber-primary/60 mb-1 block">Description</label>
                        <textarea id="editDesc" rows="4" class="cyber-input w-full p-2 text-xs" placeholder="..."></textarea>
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-cyber-primary/60 mb-1 block">Keywords</label>
                        <textarea id="editKeywords" rows="6" class="cyber-input w-full p-2 text-[10px] font-mono leading-relaxed" placeholder="..."></textarea>
                    </div>
                    <div>
                        <label class="text-[10px] uppercase text-cyber-alert/60 mb-1 block">Prompt Override</label>
                        <textarea id="editPrompt" rows="2" class="cyber-input w-full p-2 text-xs border-cyber-alert/30 text-cyber-alert" placeholder="Optional..."></textarea>
                    </div>
                </div>
                
                <div class="mt-4 text-[10px] text-cyber-dim text-center">
                    Changes save automatically to memory
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="keyModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="bg-black border border-cyber-primary w-full max-w-md shadow-[0_0_30px_rgba(0,255,65,0.1)]">
            <div class="bg-cyber-dim/30 p-3 border-b border-cyber-dim flex justify-between items-center">
                <span class="text-cyber-primary font-bold uppercase tracking-widest text-xs">Security Protocol</span>
                <button onclick="toggleKeyModal()" class="text-cyber-dim hover:text-cyber-primary"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="p-6">
                <div class="mb-4 text-center">
                    <i data-lucide="shield-lock" class="w-10 h-10 text-cyber-primary mx-auto mb-2"></i>
                    <h3 class="text-white font-bold mb-1">Enter Gemini API Key</h3>
                    <p class="text-xs text-cyber-primary/60">Required for external hosting (GitHub Pages, etc.)</p>
                </div>
                <input type="password" id="apiKeyInput" class="cyber-input w-full p-3 text-sm mb-2 text-center" placeholder="AIzaSy...">
                <p class="text-[10px] text-cyber-dim text-center mb-4">Key is stored locally in your browser. Never sent to our servers.</p>
                <div class="flex justify-center">
                    <button onclick="saveKey()" class="btn-cyber px-6 py-2 text-xs w-full">AUTHENTICATE</button>
                </div>
                <div class="mt-4 text-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-cyber-primary/40 hover:text-cyber-primary underline">Get Free Key Here</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Overlay for Errors -->
    <div id="errorToast" class="fixed bottom-4 right-4 max-w-sm bg-black border border-cyber-alert text-cyber-alert p-4 text-xs shadow-lg hidden z-50">
        <div class="font-bold mb-1 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-3 h-3"></i> ERROR</div>
        <div id="errorText"></div>
    </div>

    <script>
        // --- CONFIG ---
        const DEFAULT_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // --- STATE ---
        let fileQueue = []; 
        let isProcessing = false;
        let selectedIndex = -1;
        
        // --- API KEY INIT ---
        // Checks LocalStorage first, if empty uses the provided DEFAULT KEY
        let userApiKey = localStorage.getItem("metagen_api_key") || "AIzaSyC5EpEgYA9oovtRdIgkF3eZkUpGb4N-Ur8";

        // --- DOM ELEMENTS ---
        const els = {
            fileListBody: document.getElementById('fileListBody'),
            queueCount: document.getElementById('queueCount'),
            btnGenerate: document.getElementById('generateButton'),
            btnExport: document.getElementById('exportButton'),
            activeImg: document.getElementById('activeImage'),
            activeImgContainer: document.getElementById('activeImageContainer'),
            progressBar: document.getElementById('progressBar'),
            status: document.getElementById('systemStatus'),
            keyModal: document.getElementById('keyModal'),
            keyInput: document.getElementById('apiKeyInput'),
            inputs: {
                title: document.getElementById('editTitle'),
                desc: document.getElementById('editDesc'),
                kw: document.getElementById('editKeywords'),
                prompt: document.getElementById('editPrompt')
            }
        };

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            // No need to check for key presence since we have a default hardcoded now
        };

        // --- API KEY HANDLING ---
        window.toggleKeyModal = () => {
            if (els.keyModal.classList.contains('hidden')) {
                // Show current key (masked if it's the default/hardcoded one for security, or just show it)
                els.keyInput.value = userApiKey;
                els.keyModal.classList.remove('hidden');
            } else {
                els.keyModal.classList.add('hidden');
            }
        };

        window.saveKey = () => {
            const val = els.keyInput.value.trim();
            if (val) {
                userApiKey = val;
                localStorage.setItem("metagen_api_key", val);
                toggleKeyModal();
                alert("Key saved securely to browser storage.");
            } else {
                alert("Please enter a valid key.");
            }
        };

        // --- CORE LOGIC ---

        function handleFileSelect(files) {
            const newFiles = Array.from(files);
            if (newFiles.length === 0) return;

            const startIndex = fileQueue.length;
            const newItems = newFiles.map((file, i) => ({
                id: startIndex + i,
                file: file,
                name: file.name,
                status: 'pending', 
                title: '',
                description: '',
                keywords: [],
                prompt: ''
            }));

            fileQueue = [...fileQueue, ...newItems];
            
            renderList();
            updateStats();
            
            if (selectedIndex === -1) selectItem(startIndex);
        }

        function renderList() {
            if (fileQueue.length === 0) return;

            els.fileListBody.innerHTML = fileQueue.map((item, index) => {
                let statusColor = 'text-cyber-dim';
                let statusText = 'PENDING';
                let rowClass = index === selectedIndex ? 'active-row bg-cyber-primary/5' : 'hover:bg-cyber-dim/20';

                if (item.status === 'processing') {
                    statusColor = 'text-cyber-warning animate-pulse';
                    statusText = 'PROCESSING...';
                    rowClass += ' bg-cyber-dim/30';
                } else if (item.status === 'complete') {
                    statusColor = 'text-cyber-primary';
                    statusText = 'DONE';
                } else if (item.status === 'error') {
                    statusColor = 'text-cyber-alert';
                    statusText = 'FAILED';
                }

                return `
                    <tr onclick="selectItem(${index})" class="cursor-pointer transition-colors border-b border-cyber-dim/20 ${rowClass}">
                        <td class="p-2 font-mono text-cyber-dim">${index + 1}</td>
                        <td class="p-2 truncate max-w-[150px]" title="${item.name}">${item.name}</td>
                        <td class="p-2 font-mono text-[10px] ${statusColor}">${statusText}</td>
                        <td class="p-2 truncate max-w-[200px] text-cyber-primary/60 italic">${item.title || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            els.queueCount.innerText = fileQueue.length;
            els.btnGenerate.disabled = fileQueue.length === 0 || isProcessing;
            
            const completed = fileQueue.filter(i => i.status === 'complete').length;
            els.btnExport.disabled = completed === 0;
            
            const total = fileQueue.length;
            const processed = fileQueue.filter(i => i.status === 'complete' || i.status === 'error').length;
            const percent = total === 0 ? 0 : (processed / total) * 100;
            els.progressBar.style.width = `${percent}%`;
        }

        // --- SELECTION & EDITOR ---

        window.selectItem = (index) => {
            selectedIndex = index;
            const item = fileQueue[index];
            
            els.inputs.title.value = item.title;
            els.inputs.desc.value = item.description;
            els.inputs.kw.value = item.keywords.join(', ');
            els.inputs.prompt.value = item.prompt;

            renderList(); 
            showPreviewImage(item.file);
        };

        els.inputs.title.oninput = (e) => { if(selectedIndex>-1) fileQueue[selectedIndex].title = e.target.value; renderList(); };
        els.inputs.desc.oninput = (e) => { if(selectedIndex>-1) fileQueue[selectedIndex].description = e.target.value; };
        els.inputs.kw.oninput = (e) => { if(selectedIndex>-1) fileQueue[selectedIndex].keywords = e.target.value.split(',').map(s=>s.trim()); };
        els.inputs.prompt.oninput = (e) => { if(selectedIndex>-1) fileQueue[selectedIndex].prompt = e.target.value; };

        // --- IMAGE HANDLING (ZERO LEAK) ---

        let currentObjectUrl = null;

        function showPreviewImage(file) {
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }

            if (!file) {
                els.activeImg.classList.add('hidden');
                els.activeImgContainer.classList.remove('hidden');
                return;
            }

            currentObjectUrl = URL.createObjectURL(file);
            els.activeImg.src = currentObjectUrl;
            els.activeImg.classList.remove('hidden');
            els.activeImgContainer.classList.add('hidden');
        }

        // --- PROCESSING LOGIC ---

        function resizeAndBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const max = 800; 
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > max) { h *= max/w; w = max; } }
                        else { if (h > max) { w *= max/h; h = max; } }
                        
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.6).split(',')[1]);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function startProcessing() {
            // CHECK KEY FIRST
            if (!userApiKey) {
                alert("API Key is missing! Please configure it in the key menu (top right).");
                toggleKeyModal();
                return;
            }

            if (isProcessing) return;
            isProcessing = true;
            els.btnGenerate.disabled = true;
            els.status.innerText = "SYSTEM_BUSY // PROCESSING QUEUE";

            for (let i = 0; i < fileQueue.length; i++) {
                if (fileQueue[i].status === 'pending') {
                    await processItem(i);
                }
            }

            isProcessing = false;
            els.btnGenerate.disabled = false;
            els.status.innerText = "SYSTEM_IDLE // JOB COMPLETE";
            updateStats();
        }

        async function processItem(index) {
            const item = fileQueue[index];
            
            item.status = 'processing';
            selectItem(index); 
            updateStats();
            renderList();

            const maxRetries = 3;
            let retryCount = 0;
            let success = false;

            while (!success && retryCount < maxRetries) {
                try {
                    const base64 = await resizeAndBase64(item.file);
                    
                    const prompt = "Generate stock photo metadata. Required keys: 'title' (string), 'description' (string), 'keywords' (array of strings, min 35 items). Output STRICT JSON only.";
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${DEFAULT_MODEL}:generateContent?key=${userApiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [{text: prompt}, {inlineData: {mimeType: "image/jpeg", data: base64}}] }],
                            generationConfig: { 
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        "title": { "type": "STRING" },
                                        "description": { "type": "STRING" },
                                        "keywords": { "type": "ARRAY", "items": { "type": "STRING" } }
                                    },
                                    required: ["title", "description", "keywords"]
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => "Unknown API Error");
                        throw new Error(`API_ERR ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("NO_DATA");

                    text = text.trim();
                    if (text.startsWith('```')) {
                         text = text.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/\s*```$/, '');
                    }

                    const json = JSON.parse(text);
                    
                    item.title = json.title || json.Title || "";
                    item.description = json.description || json.Description || "";
                    item.keywords = json.keywords || json.Keywords || [];
                    item.status = 'complete';

                    if (selectedIndex === index) {
                        els.inputs.title.value = item.title;
                        els.inputs.desc.value = item.description;
                        els.inputs.kw.value = item.keywords.join(', ');
                    }
                    success = true;

                } catch (err) {
                    console.error(`Retry ${retryCount+1}/${maxRetries} failed:`, err);
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        item.status = 'error';
                        const msg = err.message.length > 50 ? err.message.substring(0, 50) + "..." : err.message;
                        showError(`Item #${index + 1} Failed: ${msg}`);
                    } else {
                        await new Promise(r => setTimeout(r, 2000 * retryCount));
                    }
                }
            }
            
            renderList();
            updateStats();
        }

        // --- UTILS ---

        function showError(msg) {
            const toast = document.getElementById('errorToast');
            document.getElementById('errorText').innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        }

        window.exportCSV = () => {
            const rows = [["Filename","Title","Description","Keywords"]];
            fileQueue.forEach(f => {
                if (f.status === 'complete') {
                    rows.push([
                        `"${f.name}"`,
                        `"${f.title.replace(/"/g, '""')}"`,
                        `"${f.description.replace(/"/g, '""')}"`,
                        `"${f.keywords.join(', ')}"`
                    ]);
                }
            });
            
            const blob = new Blob([rows.join("\n")], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `METAGEN_EXPORT_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        window.handleFileSelect = handleFileSelect;
        window.startProcessing = startProcessing;
    </script>
</body>
</html>
